{
  "rules": {
    // Default deny all rule
    ".read": false,
    ".write": false,

    "users": {
      "$uid": {
        // Users can read and write only their own data
        ".read": "$uid === auth.uid",
        ".write": "$uid === auth.uid",
        ".validate": "newData.hasChildren(['role', 'name', 'phoneNumber'])",
        "role": {
          ".validate": "newData.isString() && newData.val().matches('^(ADMIN|FARMER|WORKER)$')"
        },
        "name": {
          ".validate": "newData.isString() && newData.val().length > 0"
        },
        "phoneNumber": {
          ".validate": "newData.isString() && newData.val().matches('^[+]?[0-9]{10,13}$')"
        }
      }
    },

    "farms": {
      // Only authenticated users can read farms
      ".read": "auth != null",
      "$farmId": {
        // Only the owner can write to their farms
        ".write": "auth != null && (!data.exists() || data.child('farmerId').val() === auth.uid)",
        ".validate": "newData.hasChildren(['farmerId', 'farmDetails', 'metadata'])",
        "farmerId": {
          ".validate": "newData.isString() && newData.val() === auth.uid"
        },
        "farmDetails": {
          ".validate": "newData.hasChildren(['name', 'totalArea'])",
          "name": {
            ".validate": "newData.isString() && newData.val().length > 0"
          },
          "totalArea": {
            ".validate": "newData.isNumber() && newData.val() > 0"
          }
        },
        "metadata": {
          ".validate": "newData.hasChildren(['createdAt', 'updatedAt'])",
          "createdAt": {
            ".validate": "newData.isNumber()"
          },
          "updatedAt": {
            ".validate": "newData.isNumber() && newData.val() >= data.child('createdAt').val()"
          }
        }
      }
    },

    "businessPartners": {
      // Only authenticated users can read business partners
      ".read": "auth != null",
      "$partnerId": {
        // Only the farmer can write to their business partners
        ".write": "auth != null && (!data.exists() || data.child('farmerId').val() === auth.uid)",
        ".validate": "newData.hasChildren(['farmerId', 'partnerInfo', 'metadata'])",
        "farmerId": {
          ".validate": "newData.isString() && newData.val() === auth.uid"
        },
        "partnerInfo": {
          ".validate": "newData.hasChildren(['businessName', 'type'])",
          "businessName": {
            ".validate": "newData.isString() && newData.val().length > 0"
          },
          "type": {
            ".validate": "newData.isString() && newData.val().matches('^(Buyer|Supplier|Both)$')"
          },
          "gstNumber": {
            ".validate": "!newData.exists() || (newData.isString() && newData.val().matches('^[0-9]{2}[A-Z]{5}[0-9]{4}[A-Z]{1}[1-9A-Z]{1}Z[0-9A-Z]{1}$'))"
          },
          "panNumber": {
            ".validate": "!newData.exists() || (newData.isString() && newData.val().matches('^[A-Z]{5}[0-9]{4}[A-Z]{1}$'))"
          }
        },
        "preferences": {
          "preferredCrops": {
            ".validate": "newData.isString() || newData.hasChildren()"
          },
          "paymentTerms": {
            ".validate": "newData.isString() && newData.val().matches('^(Immediate|7Days|15Days|30Days)$')"
          },
          "minimumOrder": {
            ".validate": "newData.isNumber() && newData.val() >= 0"
          }
        },
        "transactionHistory": {
          "totalPurchases": {
            ".validate": "newData.isNumber() && newData.val() >= 0"
          },
          "totalAmount": {
            ".validate": "newData.isNumber()"
          },
          "outstandingAmount": {
            ".validate": "newData.isNumber()"
          }
        },
        "metadata": {
          ".validate": "newData.hasChildren(['createdAt'])",
          "createdAt": {
            ".validate": "newData.isNumber()"
          },
          "rating": {
            ".validate": "!newData.exists() || (newData.isNumber() && newData.val() >= 0 && newData.val() <= 5)"
          }
        }
      }
    },

    "schedules": {
      // Only authenticated users can read schedules
      ".read": "auth != null",
      "$scheduleId": {
        // Farm owners can write schedules and labourers can update their status
        ".write": "auth != null && (!data.exists() || data.child('farmerId').val() === auth.uid || root.child('schedules').child($scheduleId).child('assignedLabourers').child(auth.uid).exists())",
        ".validate": "newData.hasChildren(['farmerId', 'scheduleInfo', 'metadata'])",
        "farmerId": {
          ".validate": "newData.isString() && newData.val() === auth.uid"
        },
        "scheduleInfo": {
          ".validate": "newData.hasChildren(['title', 'date', 'startTime', 'endTime', 'workType', 'priority'])",
          "title": {
            ".validate": "newData.isString() && newData.val().length > 0"
          },
          "date": {
            ".validate": "newData.isNumber()"
          },
          "startTime": {
            ".validate": "newData.isNumber()"
          },
          "endTime": {
            ".validate": "newData.isNumber() && newData.val() > newData.parent().child('startTime').val()"
          },
          "workType": {
            ".validate": "newData.isString() && newData.val().matches('^(PLOWING|SOWING|IRRIGATION|HARVESTING|MAINTENANCE|OTHER)$')"
          },
          "priority": {
            ".validate": "newData.isString() && newData.val().matches('^(HIGH|MEDIUM|LOW)$')"
          }
        },
        "assignedLabourers": {
          "$labourerId": {
            ".validate": "newData.hasChildren(['name', 'status'])",
            "name": {
              ".validate": "newData.isString() && newData.val().length > 0"
            },
            "status": {
              ".validate": "newData.isString() && newData.val().matches('^(ASSIGNED|CONFIRMED|COMPLETED|ABSENT)$')"
            }
          }
        },
        "metadata": {
          ".validate": "newData.hasChildren(['createdAt', 'createdBy'])",
          "createdAt": {
            ".validate": "newData.isNumber()"
          },
          "createdBy": {
            ".validate": "newData.isString() && newData.val() === auth.uid"
          }
        }
      }
    },

    "crops": {
      // Only authenticated users can read crops
      ".read": "auth != null",
      "$cropId": {
        // Only the owner can write to their crops
        ".write": "auth != null && (!data.exists() || data.child('farmerId').val() === auth.uid)",
        ".validate": "newData.hasChildren(['farmerId', 'farmId', 'cropInfo', 'lifecycle', 'metadata'])",
        "farmerId": {
          ".validate": "newData.isString() && newData.val() === auth.uid"
        },
        "farmId": {
          ".validate": "newData.isString() && root.child('farms').child(newData.val()).exists()"
        },
        "cropInfo": {
          ".validate": "newData.hasChildren(['type', 'variety', 'category'])",
          "type": {
            ".validate": "newData.isString() && newData.val().length > 0"
          },
          "variety": {
            ".validate": "newData.isString() && newData.val().length > 0"
          },
          "category": {
            ".validate": "newData.isString() && newData.val().length > 0"
          }
        },
        "lifecycle": {
          ".validate": "newData.hasChildren(['status', 'sowingDate', 'expectedHarvestDate'])",
          "status": {
            ".validate": "newData.isString() && newData.val().matches('^(PLANNING|ACTIVE|HARVESTED|FAILED)$')"
          },
          "sowingDate": {
            ".validate": "newData.isNumber()"
          },
          "expectedHarvestDate": {
            ".validate": "newData.isNumber() && newData.val() > newData.parent().child('sowingDate').val()"
          }
        },
        "metadata": {
          ".validate": "newData.hasChildren(['createdAt', 'updatedAt'])",
          "createdAt": {
            ".validate": "newData.isNumber()"
          },
          "updatedAt": {
            ".validate": "newData.isNumber() && newData.val() >= data.child('createdAt').val()"
          }
        }
      }
    },

    "storage": {
      // Only authenticated users can read storage
      ".read": "auth != null",
      "$storageId": {
        // Only the owner can write to their storage
        ".write": "auth != null && (!data.exists() || data.child('farmerId').val() === auth.uid)",
        ".validate": "newData.hasChildren(['farmerId', 'storageInfo', 'metadata'])",
        "farmerId": {
          ".validate": "newData.isString() && newData.val() === auth.uid"
        },
        "storageInfo": {
          ".validate": "newData.hasChildren(['name', 'type', 'capacity', 'currentOccupancy'])",
          "name": {
            ".validate": "newData.isString() && newData.val().length > 0"
          },
          "type": {
            ".validate": "newData.isString() && newData.val().matches('^(BARN|WAREHOUSE|COLD_STORAGE|OPEN_STORAGE)$')"
          },
          "capacity": {
            ".validate": "newData.isNumber() && newData.val() > 0"
          },
          "currentOccupancy": {
            ".validate": "newData.isNumber() && newData.val() >= 0 && newData.val() <= newData.parent().child('capacity').val()"
          }
        },
        "inventory": {
          "$itemId": {
            ".validate": "newData.hasChildren(['cropId', 'quantity'])",
            "cropId": {
              ".validate": "newData.isString() && root.child('crops').child(newData.val()).exists()"
            },
            "quantity": {
              ".validate": "newData.isNumber() && newData.val() > 0"
            }
          }
        },
        "metadata": {
          ".validate": "newData.hasChildren(['createdAt', 'updatedAt'])",
          "createdAt": {
            ".validate": "newData.isNumber()"
          },
          "updatedAt": {
            ".validate": "newData.isNumber() && newData.val() >= data.child('createdAt').val()"
          }
        }
      }
    }
  }
}
